# This builds an Ubuntu image, clones the coreclr github repo and builds it.
# It then sets up the environment for compiling the New Relic .NET profiler.
FROM --platform=linux/arm64/v8 ubuntu:18.04

# Install the build tools that the profiler requires
RUN apt-get update -q -y && apt-get install -y \
 wget \
 curl \
 git \
 dos2unix \
 software-properties-common \
 make \
 binutils \
 libc++-dev \
 clang-3.9 \
 lldb-3.9 \
 build-essential

RUN echo "deb https://apt.llvm.org/trusty/ llvm-toolchain-trusty-3.9 main" | tee /etc/apt/sources.list.d/llvm.list
RUN wget --no-cache --no-cookies -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -

# The CoreCLR build notes say their repos should be pulled into a `git` directory.
# That probably isn't necessary, but whatever.
RUN mkdir /root/git
WORKDIR /root/git

RUN git clone --branch release/3.1 https://github.com/dotnet/coreclr.git

# # Remove expired root CA cert
# RUN sed -i 's/mozilla\/DST_Root_CA_X3.crt/!mozilla\/DST_Root_CA_X3.crt/g' /etc/ca-certificates.conf
# RUN update-ca-certificates

# Install cmake for Arm64 (Aarch64)
RUN curl -sSL https://virtuoso-testing.s3.us-west-2.amazonaws.com/cmake-3.9.0-rc3-aarch64.tar.gz | tar -xzC /opt
RUN chmod 777 /opt/cmake-3.9.0-rc3-aarch64/bin/cmake
RUN ln -s /opt/cmake-3.9.0-rc3-aarch64/bin/cmake /usr/bin/cmake || true

RUN rm /usr/bin/cc || true; ln -s /usr/bin/clang-3.9 /usr/bin/cc
RUN rm /usr/bin/c++ || true; ln -s /usr/bin/clang++-3.9 /usr/bin/c++
